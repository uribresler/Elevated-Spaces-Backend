generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model user {
  id                    String                 @id @default(uuid()) @map("id")
  email                 String                 @unique @map("email")
  password_hash         String?                @map("password_hash")
  name                  String?                @map("name")
  created_at            DateTime               @default(now()) @map("created_at")
  updated_at            DateTime               @updatedAt @map("updated_at")
  stripe_customer_id    String?                @map("stripe_customer_id")
  deleted_at            DateTime?              @map("deleted_at")
  auth_provider         auth_provider          @default(LOCAL) @map("auth_provider")
  avatar_url            String?                @map("avatar_url")
  google_id             String?                @unique @map("google_id")
  apple_id              String?                @unique @map("apple_id")
  facebook_id           String?                @unique @map("facebook_id")
  analytics_events      analytics_event[]
  bookings              booking[]              @relation("UserBookings")
  credits               credit[]
  guest_tracking        guest_tracking[]
  images                image[]
  payments              payment[]
  photographer_profile  photographer_profile?
  // System RBAC roles (ADMIN, PHOTOGRAPHER, USER)
  system_roles          user_roles[]           @relation("system_roles")
  owned_teams           teams[]                @relation("TeamOwner")
  // Team-specific memberships and invitations
  team_memberships      team_membership[]      @relation("TeamMember")
  team_invites_sent     team_invites[]         @relation("InvitesSent")
  team_invites_accepted team_invites[]         @relation("InvitesAccepted")
  // Personal credit tracking
  credit_balance        user_credit_balance?
  credit_purchases      user_credit_purchase[] @relation("CreditPurchases")
  credit_usage          user_credit_usage[]

  @@map("user")
}

model teams {
  id          String            @id @default(uuid()) @map("id")
  name        String            @map("name")
  owner_id    String            @map("owner_id")
  description String?           @map("description")
  // Team credit pool: owner buys credits here, allocates to members
  wallet      Int               @default(0) @map("wallet")
  created_at  DateTime          @default(now()) @map("created_at")
  updated_at  DateTime          @updatedAt @map("updated_at")
  deleted_at  DateTime?         @map("deleted_at")
  owner       user              @relation("TeamOwner", fields: [owner_id], references: [id])
  members     team_membership[]
  purchases   team_purchase[]
  usage_log   team_usage[]
  teamInvites team_invites[]

  @@map("teams")
}

model team_membership {
  id           String       @id @default(uuid()) @map("id")
  team_id      String       @map("team_id")
  user_id      String       @map("user_id")
  team_role_id String       @map("team_role_id")
  // Credits allocated to this member from team pool
  allocated    Int          @default(0) @map("allocated")
  // Credits used by this member (sum of team_usage for this member)
  used         Int          @default(0) @map("used")
  joined_at    DateTime     @default(now()) @map("joined_at")
  updated_at   DateTime     @updatedAt @map("updated_at")
  user         user         @relation("TeamMember", fields: [user_id], references: [id], onDelete: Cascade)
  team         teams        @relation(fields: [team_id], references: [id], onDelete: Cascade)
  role         team_roles   @relation(fields: [team_role_id], references: [id])
  usage_log    team_usage[]

  @@unique([team_id, user_id])
  @@map("team_membership")
}

// Track usage per member
model team_usage {
  id            String          @id @default(uuid()) @map("id")
  membership_id String          @map("membership_id")
  image_id      String          @map("image_id")
  credits_used  Int             @map("credits_used")
  created_at    DateTime        @default(now()) @map("created_at")
  membership    team_membership @relation(fields: [membership_id], references: [id], onDelete: Cascade)
  teams         teams?          @relation(fields: [teamsId], references: [id])
  teamsId       String?

  @@index([membership_id, created_at])
  @@map("team_usage")
}

// When owner purchases credits for team
model team_purchase {
  id                String    @id @default(uuid()) @map("id")
  team_id           String    @map("team_id")
  amount            Int       @map("amount")
  price_usd         Float     @map("price_usd")
  status            String    @default("pending") @map("status")
  stripe_session_id String?   @map("stripe_session_id")
  stripe_invoice_id String?   @map("stripe_invoice_id")
  created_at        DateTime  @default(now()) @map("created_at")
  completed_at      DateTime? @map("completed_at")
  team              teams     @relation(fields: [team_id], references: [id], onDelete: Cascade)

  @@index([team_id, status])
  @@map("team_purchase")
}

// Personal credits: separate from team allocation
model user_credit_balance {
  id         String   @id @default(uuid()) @map("id")
  user_id    String   @unique @map("user_id")
  balance    Int      @default(0) @map("balance")
  updated_at DateTime @updatedAt @map("updated_at")
  user       user     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_credit_balance")
}

// User purchases personal credits
model user_credit_purchase {
  id                String         @id @default(uuid()) @map("id")
  user_id           String         @map("user_id")
  package_id        String         @map("package_id")
  amount            Int            @map("amount")
  price_usd         Float          @map("price_usd")
  status            String         @default("pending") @map("status")
  stripe_session_id String?        @map("stripe_session_id")
  stripe_invoice_id String?        @map("stripe_invoice_id")
  created_at        DateTime       @default(now()) @map("created_at")
  completed_at      DateTime?      @map("completed_at")
  user              user           @relation("CreditPurchases", fields: [user_id], references: [id])
  package           credit_package @relation("UserCreditPurchases", fields: [package_id], references: [id])

  @@index([user_id, status])
  @@map("user_credit_purchase")
}

// Track personal credit usage
model user_credit_usage {
  id           String   @id @default(uuid()) @map("id")
  user_id      String   @map("user_id")
  image_id     String   @map("image_id")
  credits_used Int      @map("credits_used")
  created_at   DateTime @default(now()) @map("created_at")
  user         user     @relation(fields: [user_id], references: [id])

  @@index([user_id, created_at])
  @@map("user_credit_usage")
}

model team_invites {
  id                        String        @id @default(uuid()) @map("id")
  team_id                   String        @map("team_id")
  email                     String        @map("email")
  team_role_id              String        @map("team_role_id")
  role_permissions_snapshot String?       @map("role_permissions_snapshot")
  invited_by_user_id        String        @map("invited_by_user_id")
  credit_limit              Int?          @default(0) @map("credit_limit")
  token                     String        @unique @map("token")
  status                    invite_status @default(PENDING) @map("status")
  invited_at                DateTime      @default(now()) @map("invited_at")
  expires_at                DateTime      @map("expires_at")
  accepted_at               DateTime?     @map("accepted_at")
  accepted_by_user_id       String?       @map("accepted_by_user_id")
  created_at                DateTime      @default(now()) @map("created_at")
  updated_at                DateTime      @updatedAt @map("updated_at")
  team                      teams         @relation(fields: [team_id], references: [id], onDelete: Cascade)
  role                      team_roles    @relation(fields: [team_role_id], references: [id])
  invited_by                user          @relation("InvitesSent", fields: [invited_by_user_id], references: [id])
  accepted_by               user?         @relation("InvitesAccepted", fields: [accepted_by_user_id], references: [id])

  @@unique([team_id, email])
  @@map("team_invites")
}

model photographer_profile {
  id                          String    @id @default(uuid()) @map("id")
  user_id                     String    @unique @map("user_id")
  bio                         String?   @map("bio")
  documents_url               String?   @map("documents_url")
  approved                    Boolean   @default(false) @map("approved")
  availability                String?   @map("availability")
  stripe_connected_account_id String?   @map("stripe_connected_account_id")
  created_at                  DateTime  @default(now()) @map("created_at")
  updated_at                  DateTime  @updatedAt @map("updated_at")
  bookings                    booking[] @relation("PhotographerBookings")
  user                        user      @relation(fields: [user_id], references: [id])

  @@map("photographer_profile")
}

model guest_tracking {
  id            String   @id @default(uuid()) @map("id")
  ip            String   @map("ip")
  fingerprint   String   @map("fingerprint")
  uploads_count Int      @default(0) @map("uploads_count")
  blocked       Boolean  @default(false) @map("blocked")
  last_used_at  DateTime @default(now()) @map("last_used_at")
  userId        String?
  user          user?    @relation(fields: [userId], references: [id])
  images        image[]

  @@map("guest_tracking")
}

model image {
  id                      String            @id @default(uuid()) @map("id")
  user_id                 String?           @map("user_id")
  guest_id                String?           @map("guest_id")
  original_image_url      String            @map("original_image_url")
  staged_image_url        String?           @map("staged_image_url")
  watermarked_preview_url String?           @map("watermarked_preview_url")
  status                  image_status      @default(PROCESSING) @map("status")
  is_demo                 Boolean           @default(false) @map("is_demo")
  mls_label_enabled       Boolean           @default(false) @map("mls_label_enabled")
  room_type               String?           @map("room_type")
  staging_style           String?           @map("staging_style")
  prompt                  String?           @map("prompt")
  // ❌ REMOVED: credits_used (stored here). Use team_credit_ledger + team_credit_actions instead.
  revisions               Int               @default(0) @map("revisions")
  max_revisions           Int               @default(3) @map("max_revisions")
  created_at              DateTime          @default(now()) @map("created_at")
  updated_at              DateTime          @updatedAt @map("updated_at")
  source                  String?           @default("demo") @map("source")
  analytics_events        analytics_event[]
  guest_tracking          guest_tracking?   @relation(fields: [guest_id], references: [id])
  user                    user?             @relation(fields: [user_id], references: [id])

  @@map("image")
}

// ⚠️  DEPRECATED: Individual user credits. Use team wallet + team_credit_usage instead.
// Kept for backward compatibility only. All new credit logic should use team_credit_usage.
// Migration path: Transfer individual credits to team wallet when user creates/joins team.
model credit {
  id         String          @id @default(uuid()) @map("id")
  user_id    String          @map("user_id")
  total      Int             @map("total")
  used       Int             @default(0) @map("used")
  available  Int             @default(0) @map("available")
  package_id String?         @map("package_id")
  created_at DateTime        @default(now()) @map("created_at")
  updated_at DateTime        @updatedAt @map("updated_at")
  package    credit_package? @relation(fields: [package_id], references: [id])
  user       user            @relation(fields: [user_id], references: [id])

  @@map("credit")
}

model credit_package {
  id                    String                 @id @default(uuid()) @map("id")
  name                  String                 @map("name")
  credits               Int                    @map("credits")
  price                 Float                  @map("price")
  currency              String                 @default("usd") @map("currency")
  active                Boolean                @default(true) @map("active")
  created_at            DateTime               @default(now()) @map("created_at")
  updated_at            DateTime               @updatedAt @map("updated_at")
  legacy_credit_usage   credit[]
  user_credit_purchases user_credit_purchase[] @relation("UserCreditPurchases")

  @@map("credit_package")
}

model payment {
  id                String         @id @default(uuid()) @map("id")
  user_id           String         @map("user_id")
  amount            Float          @map("amount")
  currency          String         @default("usd") @map("currency")
  status            payment_status @default(PENDING) @map("status")
  stripe_session_id String?        @map("stripe_session_id")
  created_at        DateTime       @default(now()) @map("created_at")
  booking           booking?
  user              user           @relation(fields: [user_id], references: [id])

  @@map("payment")
}

model booking {
  id               String               @id @default(uuid()) @map("id")
  user_id          String               @map("user_id")
  photographer_id  String               @map("photographer_id")
  date             DateTime             @map("date")
  status           booking_status       @default(PENDING) @map("status")
  payment_id       String?              @unique @map("payment_id")
  payment_status   payment_status       @default(PENDING) @map("payment_status")
  transaction_id   String?              @map("transaction_id")
  created_at       DateTime             @default(now()) @map("created_at")
  updated_at       DateTime             @updatedAt @map("updated_at")
  analytics_events analytics_event[]
  payment          payment?             @relation(fields: [payment_id], references: [id])
  photographer     photographer_profile @relation("PhotographerBookings", fields: [photographer_id], references: [id])
  user             user                 @relation("UserBookings", fields: [user_id], references: [id])

  @@map("booking")
}

model analytics_event {
  id          String   @id @default(uuid()) @map("id")
  user_id     String?  @map("user_id")
  image_id    String?  @map("image_id")
  booking_id  String?  @map("booking_id")
  event_type  String   @map("event_type")
  ip          String?  @map("ip")
  device_type String?  @map("device_type")
  location    String?  @map("location")
  language    String?  @map("language")
  source      String?  @map("source")
  timestamp   DateTime @default(now()) @map("timestamp")
  booking     booking? @relation(fields: [booking_id], references: [id])
  image       image?   @relation(fields: [image_id], references: [id])
  user        user?    @relation(fields: [user_id], references: [id])

  @@map("analytics_event")
}

model admin_content {
  id         String   @id @default(uuid()) @map("id")
  page       String   @unique @map("page")
  content    String   @map("content")
  updated_at DateTime @updatedAt @map("updated_at")
  created_at DateTime @default(now()) @map("created_at")

  @@map("admin_content")
}

model roles {
  id          String             @id @default(uuid()) @map("id")
  name        String             @unique @map("name")
  description String?            @map("description")
  created_at  DateTime           @default(now()) @map("created_at")
  updated_at  DateTime           @updatedAt @map("updated_at")
  permissions role_permissions[]
  users       user_roles[]

  @@map("roles")
}

// Separate team-specific roles from system RBAC
model team_roles {
  id          String            @id @default(uuid()) @map("id")
  name        String            @unique @map("name")
  description String?           @map("description")
  // JSON for future permission matrix (view_reports, manage_team, assign_credits, etc.)
  permissions Json?           @map("permissions")
  created_at  DateTime          @default(now()) @map("created_at")
  updated_at  DateTime          @updatedAt @map("updated_at")
  members     team_membership[]
  invites     team_invites[]

  @@map("team_roles")
}

model permissions {
  id          String             @id @default(uuid()) @map("id")
  name        String             @unique @map("name")
  description String?
  created_at  DateTime           @default(now()) @map("created_at")
  updated_at  DateTime           @default(now()) @updatedAt @map("updated_at")
  roles       role_permissions[]
}

model user_roles {
  id          String   @id @default(uuid()) @map("id")
  user_id     String   @map("user_id")
  role_id     String   @map("role_id")
  assigned_at DateTime @default(now()) @map("assigned_at")
  role        roles    @relation(fields: [role_id], references: [id])
  user        user     @relation("system_roles", fields: [user_id], references: [id])

  @@unique([user_id, role_id])
  @@map("user_roles")
}

model role_permissions {
  id            String      @id @default(uuid()) @map("id")
  role_id       String      @map("role_id")
  permission_id String      @map("permission_id")
  assigned_at   DateTime    @default(now()) @map("assigned_at")
  permission    permissions @relation(fields: [permission_id], references: [id])
  role          roles       @relation(fields: [role_id], references: [id])

  @@unique([role_id, permission_id])
}

enum auth_provider {
  LOCAL
  GOOGLE
  FACEBOOK
  APPLE

  @@map("auth_provider")
}

enum image_status {
  PROCESSING
  COMPLETED
  FAILED

  @@map("image_status")
}

enum payment_status {
  PENDING
  PAID
  FAILED

  @@map("payment_status")
}

enum booking_status {
  PENDING
  CONFIRMED
  CANCELLED

  @@map("booking_status")
}

enum invite_status {
  PENDING
  ACCEPTED
  REJECTED
  FAILED

  @@map("invite_status")
}
